@model List<ResultBookingDto>
@{
    ViewData["Title"] = "BookingList";
    Layout = "~/Views/AdminLayout/Index.cshtml";
}

<script src="~/lib/microsoft/signalr/dist/browser/signalr.min.js"></script>
<script src="~/lib/jquery/dist/jquery.min.js"></script>
<script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>

<div class="content">
    <div class="container-fluid">
        <h4 class="page-title">Rezervasyon İşlemleri</h4>
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Rezervasyon Listesi</div>
                    </div>
                    <div class="card-body">
                        <div class="card-sub">
                            Rezervasyon ile ilgili işlemleri aşağıdan gerçekleştirebilirsiniz
                        </div>

                        <!-- Tablo -->
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Ad</th>
                                    <th>Telefon</th>
                                    <th>Kişi Sayısı</th>
                                    <th>Email</th>
                                    <th>Durum</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody id="bookingList">
                                <!-- SignalR ile doldurulacak -->
                            </tbody>

                        </table>
                        <a href="/BookATable/Create" class="btn btn-outline-primary mb-3">Yeni Rezervasyon Girişi</a>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(() => {
        var connection = new signalR.HubConnectionBuilder()
            .withUrl("https://localhost:7267/SignalRHub")
            .withAutomaticReconnect()
            .build();

        connection.start()
            .then(() => {
                connection.invoke("GetBookingList");

                setInterval(() => {
                    connection.invoke("GetBookingList");
                }, 5000);
            })
            .catch((err) => {
                console.error("Bağlantı hatası:", err.toString());
                $("#connstatus").text("Bağlantı Hatası").css("color", "red");
            });

        connection.on("ReceiveBookingList", (bookingList) => {
            $("#bookingList").empty();

            if (bookingList && bookingList.length > 0) {
                bookingList.forEach((item, index) => {
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.name}</td>
                            <td>${item.phone}</td>
                            <td>${item.personCount}</td>
                            <td>${item.mail}</td>
                            <td><span class="badge bg-success">Rezervasyon Alındı</span></td>
                            <td>
                                <a href="/BookATable/Update/${item.bookingID}" class="btn btn-sm btn-outline-warning">Güncelle</a>
                                <a href="/BookATable/Delete/${item.bookingID}" class="btn btn-sm btn-outline-danger">Sil</a>
                            </td>
                        </tr>
                    `;
                    $("#bookingList").append(row);
                });
            } else {
                $("#bookingList").append("<tr><td colspan='7' class='text-center'>Henüz rezervasyon yok</td></tr>");
            }
        });

        // Hata olayını dinle
        connection.on("ReceiveError", (message) => {
            console.error("Hub Hatası:", message);
        });
    });
</script>
